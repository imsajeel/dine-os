generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model branches {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  name            String         @db.VarChar(255)
  address         String?
  timezone        String?        @default("UTC") @db.VarChar(50)
  phone           String?        @db.VarChar(20)
  is_active       Boolean?       @default(true)
  opening_time    String?        @db.VarChar(5)
  closing_time    String?        @db.VarChar(5)
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  floor_tables    floor_tables[]
  orders          orders[]
  users           users[]
  categories      categories[]
  menu_items      menu_items[]
  modifier_groups modifier_groups[]
}

model categories {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  name            String         @db.VarChar(100)
  sort_order      Int?           @default(0)
  is_active       Boolean?       @default(true)
  icon            String?        @db.VarChar(50)
  branch_id       String?        @db.Uuid
  branches        branches?      @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  menu_items      menu_items[]
}

model floor_tables {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  branch_id       String?        @db.Uuid
  table_number    String         @db.VarChar(10)
  capacity        Int?           @default(4)
  x_position      Int
  y_position      Int
  shape           String?        @default("round") @db.VarChar(20)
  current_status  String?        @default("free") @db.VarChar(20)
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  branches        branches?      @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  orders          orders[]
  reservations    reservations[]
  
  parent_table_id String?        @db.Uuid
  is_merged       Boolean?       @default(false)
  merged_ids      String[]       @default([])
  
  parent_table    floor_tables?  @relation("TableSplits", fields: [parent_table_id], references: [id])
  child_tables    floor_tables[] @relation("TableSplits")
}

model infrastructure_nodes {
  id             String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  region         String?       @db.VarChar(50)
  ip_address     String?       @db.Inet
  status         infra_status? @default(healthy)
  cpu_load       Int?
  memory_usage   Int?
  last_heartbeat DateTime?     @default(now()) @db.Timestamp(6)
}

model invoices {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  amount          Decimal?       @db.Decimal(10, 2)
  status          String?        @db.VarChar(20)
  pdf_url         String?
  due_date        DateTime?      @db.Date
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model menu_items {
  id                   String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id      String?        @db.Uuid
  category_id          String?        @db.Uuid
  name                 String         @db.VarChar(255)
  description          String?
  price                Decimal        @db.Decimal(10, 2)
  image_url            String?
  is_available         Boolean?       @default(true)
  preparation_time_est Int?
  created_at           DateTime?      @default(now()) @db.Timestamp(6)
  branch_id            String?        @db.Uuid
  branches             branches?      @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  categories           categories?    @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  organizations        organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  order_items          order_items[]
  item_modifiers       item_modifiers[]
}

model order_items {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  order_id        BigInt?
  menu_item_id    String?        @db.Uuid
  quantity        Int            @default(1)
  price_at_time   Decimal        @db.Decimal(10, 2)
  modifiers       Json?          @default("[]")
  notes           String?
  status          order_status?  @default(new)
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  menu_items      menu_items?    @relation(fields: [menu_item_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  orders          orders?        @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([organization_id], map: "idx_items_org")
}

model orders {
  id              BigInt         @id @default(autoincrement())
  organization_id String?        @db.Uuid
  branch_id       String?        @db.Uuid
  table_id        String?        @db.Uuid
  server_id       String?        @db.Uuid
  status          order_status?  @default(new)
  total_amount    Decimal?       @default(0.00) @db.Decimal(10, 2)
  payment_status  String?        @default("unpaid") @db.VarChar(20)
  payment_method  String?        @db.VarChar(20)
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  completed_at    DateTime?      @db.Timestamp(6)
  order_items     order_items[]
  branches        branches?      @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users           users?         @relation(fields: [server_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  floor_tables    floor_tables?  @relation(fields: [table_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([branch_id], map: "idx_orders_branch")
  @@index([created_at], map: "idx_orders_created")
  @@index([organization_id], map: "idx_orders_org")
}

model organizations {
  id                 String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name               String         @db.VarChar(255)
  slug               String         @unique @db.VarChar(50)
  plan               plan_tier?     @default(starter)
  max_branches       Int?           @default(1)
  status             org_status?    @default(trial)
  stripe_customer_id String?        @db.VarChar(255)
  config_settings    Json?          @default("{}")
  currency           String?        @default("GBP") @db.VarChar(3)
  created_at         DateTime?      @default(now()) @db.Timestamp(6)
  updated_at         DateTime?      @default(now()) @db.Timestamp(6)
  branches           branches[]
  categories         categories[]
  floor_tables       floor_tables[]
  invoices           invoices[]
  menu_items         menu_items[]
  modifier_groups    modifier_groups[]
  order_items        order_items[]
  orders             orders[]
  reservations       reservations[]
  users              users[]
}

model modifier_groups {
  id              String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?          @db.Uuid
  branch_id       String?          @db.Uuid
  name            String           @db.VarChar(100)
  type            String?          @default("selection") @db.VarChar(20) // selection, text, grams
  min_selection   Int              @default(0)
  max_selection   Int              @default(1)
  created_at      DateTime?        @default(now()) @db.Timestamp(6)
  organizations   organizations?   @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  branches        branches?        @relation(fields: [branch_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  modifiers       modifiers[]
  item_modifiers  item_modifiers[]
}

model modifiers {
  id                String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  modifier_group_id String          @db.Uuid
  name              String          @db.VarChar(100)
  price             Decimal         @default(0.00) @db.Decimal(10, 2)
  is_available      Boolean?        @default(true)
  modifier_groups   modifier_groups @relation(fields: [modifier_group_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model item_modifiers {
  id                String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  menu_item_id      String          @db.Uuid
  modifier_group_id String          @db.Uuid
  menu_items        menu_items      @relation(fields: [menu_item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  modifier_groups   modifier_groups @relation(fields: [modifier_group_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model super_admins {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String    @unique @db.VarChar(255)
  password_hash String    @db.VarChar(255)
  mfa_secret    String?   @db.VarChar(255)
  last_login    DateTime? @db.Timestamp(6)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
}

model system_logs {
  id              BigInt    @id @default(autoincrement())
  severity        String?   @db.VarChar(10)
  service         String?   @db.VarChar(50)
  organization_id String?   @db.Uuid
  message         String?
  metadata        Json?
  created_at      DateTime? @default(now()) @db.Timestamp(6)
}

model users {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  branch_id       String?        @db.Uuid
  email           String         @db.VarChar(255)
  password_hash   String         @db.VarChar(255)
  pin_code        String?        @db.VarChar(10)
  role            user_role
  full_name       String?        @db.VarChar(100)
  is_active       Boolean?       @default(true)
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  orders          orders[]
  branches        branches?      @relation(fields: [branch_id], references: [id], onUpdate: NoAction)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organization_id, email])
  @@index([organization_id], map: "idx_users_org")
}

enum infra_status {
  healthy
  degraded
  offline
}

enum order_status {
  new
  prep
  ready
  served
  completed
  cancelled
}

enum org_status {
  active
  trial
  suspended
  archived
}

enum plan_tier {
  starter
  pro
  enterprise
}

enum user_role {
  org_admin
  branch_manager
  staff
}

model reservations {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  branch_id       String?        @db.Uuid
  table_id        String?        @db.Uuid
  customer_name   String         @db.VarChar(100)
  customer_phone  String?        @db.VarChar(20)
  customer_email  String?        @db.VarChar(255)
  party_size      Int
  reservation_time DateTime      @db.Timestamp(6)
  status          String?        @default("pending") @db.VarChar(20)
  deposit_amount  Decimal?       @default(0.00) @db.Decimal(10, 2)
  is_deposit_paid Boolean?       @default(false)
  notes           String?
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  floor_tables    floor_tables?  @relation(fields: [table_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}
